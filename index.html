<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Fantacalcio 25/26</title>
<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #0b1020;
    --card: #121a33;
    --text: #e8ecff;
    --accent: #7aa2ff;
    --trade-bg: #3d2a0a33;
    --trade-border: orange;
  }
  body { margin:0; font-family: system-ui, sans-serif; background: linear-gradient(180deg, var(--bg), #0d1530); color: var(--text); }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
  h1 { text-align:center; margin-bottom: 16px; }
  .tabs { text-align:center; margin-bottom: 20px; }
  .tabs button {
    background: var(--card); color: var(--text); border:1px solid #243058;
    padding:10px 16px; margin: 0 4px; border-radius: 10px; cursor:pointer; font-weight:600;
  }
  .tabs button.active { background: var(--accent); color:#0a0f20; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; width:100%; margin: 12px 0; }
  .controls select, .controls input { background: var(--card); border: 1px solid #243058; color: var(--text); padding: 8px 12px; border-radius: 12px; min-width:150px; }
  #legend { margin: 10px 0; }
  .legend-chip { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 10px; background: var(--card); border:1px solid #1a2447; font-size: 0.95rem; }
  .legend-color { width:14px; height:14px; border-radius:4px; }
  .traded { background: var(--trade-bg) !important; border-left: 3px solid var(--trade-border) !important; }
  #table { background: var(--card); border-radius:16px; overflow:hidden; border:1px solid #1a2447; margin-top: 12px; }
  .footer { opacity:.7; font-size:.85rem; padding:12px 0; }

  /* Evidenziazione righe Prezzo 1-5 */
  .highlight-lowprice {
    background: rgba(255, 215, 0, 0.15) !important;
    border-left: 3px solid gold !important;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸ“Š Gestione Fantacalcio 25/26</h1>
  <div class="tabs">
    <button data-fanta="taxo" class="active">FantaTaxo 25/26</button>
    <button data-fanta="ralph">Ralphcalcio 25/26</button>
  </div>

  <h2 id="fantasyTitle"></h2>
  <p id="introText"></p>

  <section class="controls">
    <select id="ownerFilter"><option value="">Tutti i proprietari</option></select>
    <select id="ruoloFilter"><option value="">Tutti i ruoli</option><option value="A">A</option><option value="C">C</option><option value="D">D</option><option value="P">P</option></select>
    <select id="teamFilter"><option value="">Tutti i club</option></select>
    <input id="searchBox" type="search" placeholder="Cerca giocatoreâ€¦" />
    <button id="resetBtn">Reset</button>
  </section>

  <div id="legend">
    <span class="legend-chip" id="legendTrade" style="display:none;">
      <span class="legend-color" style="background:var(--trade-bg);border:2px solid var(--trade-border);"></span> 
      Giocatori scambiati (diritto passa al nuovo proprietario)
    </span>
  </div>

  <div id="table"></div>
  <p class="footer">Suggerimenti: clicca intestazioni per ordinare â€¢ Trascina colonne per riordinarle â€¢ Usa i toggle per mostrare/nascondere colonne.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script>
const fmt0 = (n) => new Intl.NumberFormat('it-IT', { maximumFractionDigits: 0 }).format(n);

// elenco scambi Ralphcalcio
const trades = [
  { Nome: "MORATA", newOwner: "Nicola" },
  { Nome: "POLITANO", newOwner: "Nicola" },
  { Nome: "POHJANPALO", newOwner: "TENUE" },
  { Nome: "PAZ N.", newOwner: "TENUE" },
  { Nome: "DYBALA", newOwner: "TENUE" },
  { Nome: "SAVONA", newOwner: "TENUE" },
  { Nome: "PASALIC", newOwner: "Gaetano" },
  { Nome: "THAUVIN", newOwner: "Gaetano" },
  { Nome: "BUONGIORNO", newOwner: "Vincenzo" },
  { Nome: "EDERSON", newOwner: "Vincenzo" },
  { Nome: "CASTRO", newOwner: "Vincenzo" },
  { Nome: "LUCUMI'", newOwner: "Ted" },
  { Nome: "ADLI", newOwner: "Ted" },
  { Nome: "THURAM", newOwner: "Ted" }
];

async function loadCSV(path) {
  return new Promise((resolve, reject) => {
    Papa.parse(path, {
      download: true,
      header: true,
      dynamicTyping: true,
      complete: (results) => resolve(results.data),
      error: reject
    });
  });
}

async function loadExcelFVMp(path) {
  const response = await fetch(path);
  const arrayBuffer = await response.arrayBuffer();
  const workbook = XLSX.read(arrayBuffer, { type: "array" });
  const sheetName = workbook.SheetNames[0];
  const sheet = workbook.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

  const headers = json[0].map(h => h.toString().trim().toLowerCase());
  const idxNome = headers.findIndex(h => h.includes("nome"));
  const idxFvmp = headers.findIndex(h => h.includes("fvm/1000")); // ðŸ‘ˆ uso la colonna giusta

  const map = {};
  for (let i = 1; i < json.length; i++) {
    const row = json[i];
    const nome = (row[idxNome] || "").toString().trim().toUpperCase();
    const fvmp1000 = Number(row[idxFvmp]) || 0;
    map[nome] = Math.round(fvmp1000 / 2); // da /1000 a /500
  }
  return map;
}

const configs = {
  taxo: {
    name: "FantaTAXO 25/26",
    csv: "rose_fantataxo_astaagosto.csv",
    intro: "Ogni squadra ha diritto ad una riconferma secondo regolamento, da effettuarsi al valore FVMp. Si escludono portieri."
  },
  ralph: {
    name: "Ralphcalcio 25/26",
    csv: "rose_ralphcalcio_astaagosto.csv",
    intro: ""
  }
};

let table;
let currentConfig;
let fvmpMap = {};

async function loadFantasy(key) {
  currentConfig = configs[key];
  document.getElementById("fantasyTitle").textContent = currentConfig.name;
  document.getElementById("introText").textContent = currentConfig.intro;

  if (table) table.destroy();
  const data = await loadCSV(currentConfig.csv);

  if (key === "taxo") {
    fvmpMap = await loadExcelFVMp("lista_calciatori_svincolati_mantra_fantataxo.xlsx");
  }

  const columns = [
    { title: "Proprietario", field: "Squadra", widthGrow: 1 },
    { title: "Nome", field: "Nome", widthGrow: 2 },
    { title: "Ruoli Mantra", field: "Ruoli_Mantra", widthGrow: 1.2 },
    { title: "Prezzo", field: "Prezzo", hozAlign:"right", formatter:(c)=>fmt0(c.getValue()), widthGrow: 1 }
  ];

  if (key === "taxo") {
    columns.push({
      title: "FVMp",
      field: "Nome",
      hozAlign:"right",
      widthGrow: 1,
      formatter:(cell)=>{
        const nome = (cell.getValue() || "").toUpperCase();
        return fvmpMap[nome] ? fmt0(fvmpMap[nome]) : "â€”";
      }
    });
  }

  if (key === "ralph") {
    columns.push({
      title: "Nuovo proprietario",
      field:"Nome",
      widthGrow:1,
      formatter:(cell)=>{
        const trade = trades.find(t => t.Nome.toUpperCase() === cell.getValue().toUpperCase());
        return trade ? trade.newOwner : "â€”";
      }
    });
  }

  table = new Tabulator("#table", {
    data: data,
    layout: "fitColumns",
    responsiveLayout: "collapse",
    movableColumns: true,
    height: "75vh",
    columns: columns,
    rowFormatter: function(row){
      const d = row.getData();
      // Evidenzia chi ha Prezzo 1â€“5 compreso
      if (Number(d.Prezzo) >= 1 && Number(d.Prezzo) <= 5) {
        row.getElement().classList.add("highlight-lowprice");
      }
    }
  });

  // Filtri
  const ownerFilter = document.getElementById("ownerFilter");
  const ruoloFilter = document.getElementById("ruoloFilter");
  const teamFilter = document.getElementById("teamFilter");
  const searchBox = document.getElementById("searchBox");
  const resetBtn = document.getElementById("resetBtn");

  ownerFilter.innerHTML = '<option value="">Tutti i proprietari</option>';
  [...new Set(data.map(d => d.Squadra))].sort().forEach(o=>{
    const opt = document.createElement("option"); opt.value=o; opt.textContent=o; ownerFilter.appendChild(opt);
  });
  teamFilter.innerHTML = '<option value="">Tutti i club</option>';
  [...new Set(data.map(d => d.Squadra_Appartenenza))].sort().forEach(c=>{
    const opt = document.createElement("option"); opt.value=c; opt.textContent=c; teamFilter.appendChild(opt);
  });

  function applyFilters() {
    let filters = [];
    if (ownerFilter.value) filters.push({ field:"Squadra", type:"=", value: ownerFilter.value });
    if (ruoloFilter.value) filters.push({ field:"Ruolo", type:"=", value: ruoloFilter.value });
    if (teamFilter.value) filters.push({ field:"Squadra_Appartenenza", type:"=", value: teamFilter.value });
    table.clearFilter(true);
    if (filters.length) table.setFilter(filters);
    if (searchBox.value) {
      const q = searchBox.value.toLowerCase();
      table.addFilter((data) => (data.Nome || '').toLowerCase().includes(q));
    }
  }
  ownerFilter.onchange = applyFilters;
  ruoloFilter.onchange = applyFilters;
  teamFilter.onchange = applyFilters;
  searchBox.oninput = applyFilters;
  resetBtn.onclick = () => { ownerFilter.value=""; ruoloFilter.value=""; teamFilter.value=""; searchBox.value=""; table.clearFilter(true); };
}

// Inizializza con Taxo
loadFantasy('taxo');

// Gestione tab
document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    loadFantasy(btn.dataset.fanta);
  });
});
</script>
</body>
</html>
