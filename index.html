<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Riconferme FantaTaxo</title>
<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
<style>
  /* ... (stili invariati) ... */
</style>
</head>
<body>
<div class="wrap">
  <!-- header, controls e legenda invariati -->
  <div id="table"></div>
  <p class="footer">Suggerimenti: tocca le intestazioni per ordinare • Trascina le colonne per riordinarle • Usa i toggle per mostrare/nascondere colonne.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script type="module">
import data from './data.js';

const fmt0 = (n) => new Intl.NumberFormat('it-IT', { maximumFractionDigits: 0 }).format(n);

const columns = [
  { key:"Squadra", title: "Proprietario", field: "Squadra", widthGrow: 1, visible: true },
  { key:"Nome", title: "Nome", field: "Nome", widthGrow: 2, visible: true },
  { key:"Club", title: "Club", field: "Squadra_Appartenenza", widthGrow: 1, visible: true },
  { key:"Ruolo", title: "Ruolo", field: "Ruolo", widthGrow: 1, visible: false },
  { key:"Ruoli_Mantra", title: "Ruoli Mantra", field: "Ruoli_Mantra", widthGrow: 1.2, visible: true },
  { key:"Prezzo", title: "Prezzo", field: "Prezzo", hozAlign:"right", widthGrow: 1, formatter:(cell)=>fmt0(cell.getValue()), visible: true },
  { key:"Quot", title: "Quot.", field: "Quotazione", hozAlign:"right", widthGrow: 1, visible: false },
  { key:"QuotM", title: "Quot. Mantra", field: "Quotazione_Mantra", hozAlign:"right", widthGrow: 1, visible: false },
  { key:"Riconferma", title: "Riconferma (2×)", field: "Prezzo", hozAlign:"right", widthGrow: 1,
    formatter:(cell)=>{ const d = cell.getRow().getData(); const v = Number(d.Prezzo); return (v<=5 && d.Ruolo!=="P") ? fmt0(v*2) : "—"; }, visible: true },
  { key:"ID", title: "ID", field: "Fantacalcio_Id", visible:false }
];

let table = new Tabulator("#table", {
  data: data,
  layout: "fitColumns",
  responsiveLayout: "collapse",
  movableColumns: true,
  height: "75vh",
  columns: columns,
  rowFormatter: function(row){
    const d = row.getData();
    const isReconfirm = Number(d.Prezzo) <= 5 && d.Ruolo !== "P";
    row.getElement().classList.toggle("reconfirm", isReconfirm);
  }
});

// Column toggles
const colToggles = document.getElementById("colToggles");
columns.forEach(col => {
  if (col.key === "ID") return;
  const id = "chk_" + col.key;
  const label = document.createElement("label");
  const input = document.createElement("input");
  input.type = "checkbox";
  input.id = id;
  input.checked = !!col.visible;
  input.addEventListener("change", () => {
    (input.checked ? table.showColumn(col.field) : table.hideColumn(col.field));
  });
  label.appendChild(input);
  label.appendChild(document.createTextNode(" " + col.title));
  colToggles.appendChild(label);
});
columns.forEach(col => { if (col.visible === false) table.hideColumn(col.field); });

// Filters
const ownerFilter = document.getElementById("ownerFilter");
const ruoloFilter = document.getElementById("ruoloFilter");
const teamFilter = document.getElementById("teamFilter");
const searchBox = document.getElementById("searchBox");
const resetBtn = document.getElementById("resetBtn");

function applyFilters() {
  let filters = [];
  if (ownerFilter.value) filters.push({ field:"Squadra", type:"=", value: ownerFilter.value });
  if (ruoloFilter.value) filters.push({ field:"Ruolo", type:"=", value: ruoloFilter.value });
  if (teamFilter.value) filters.push({ field:"Squadra_Appartenenza", type:"=", value: teamFilter.value });

  table.clearFilter(true);
  if (filters.length) table.setFilter(filters);
  if (searchBox.value) {
    const q = searchBox.value.toLowerCase();
    table.addFilter((data) => (data.Nome || '').toLowerCase().includes(q));
  }
}

ownerFilter.addEventListener("change", applyFilters);
ruoloFilter.addEventListener("change", applyFilters);
teamFilter.addEventListener("change", applyFilters);
searchBox.addEventListener("input", applyFilters);
resetBtn.addEventListener("click", () => {
  ownerFilter.value = "";
  ruoloFilter.value = "";
  teamFilter.value = "";
  searchBox.value = "";
  table.clearFilter(true);
});
</script>
</body>
</html>
