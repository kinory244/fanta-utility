<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Fantacalcio 25/26</title>
<link href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
<style>
  :root {
    --bg: #0b1020;
    --card: #121a33;
    --text: #e8ecff;
    --muted: #9fb0ff;
    --accent: #7aa2ff;
    --chip: #1a2447;
    --chip-text: #cfe0ff;
    --reconfirm-bg: #0a3d2a33;
    --reconfirm-border: #2bd48a;
  }
  body { margin:0; font-family: system-ui, sans-serif; background: linear-gradient(180deg, var(--bg), #0d1530); color: var(--text); }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }

  #home { position: relative; z-index: 5; text-align:center; }
  #app { position: relative; z-index: 1; display:none; }

  h1, h2 { margin: 0 0 12px 0; text-align:center; }
  button { background: var(--accent); border: none; color: #0a0f20; padding: 10px 18px; margin: 10px; border-radius: 12px; font-weight: 700; cursor:pointer; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; width:100%; margin: 12px 0; }
  .controls select, .controls input { background: var(--card); border: 1px solid #243058; color: var(--text); padding: 8px 12px; border-radius: 12px; min-width:150px; }
  #legend { margin: 10px 0; }
  .legend-chip { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 10px; background: var(--card); border:1px solid #1a2447; font-size: 0.95rem; }
  .legend-color { width:14px; height:14px; border-radius:4px; background: var(--reconfirm-bg); border: 2px solid var(--reconfirm-border); }
  #table { background: var(--card); border-radius:16px; overflow:hidden; border:1px solid #1a2447; margin-top: 12px; }
  .tabulator { background: transparent; }
  .tabulator-row.reconfirm { background: var(--reconfirm-bg); border-left: 3px solid var(--reconfirm-border); }
  .footer { opacity:.7; font-size:.85rem; padding:12px 0; }
  .col-toggle { display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
  .col-toggle label { background: var(--card); border:1px solid #243058; padding:6px 10px; border-radius:10px; display:inline-flex; align-items:center; gap:6px; }
</style>
</head>
<body>
<div class="wrap">
  <!-- Home -->
  <div id="home">
    <h1>Scegli il fantacalcio</h1>
    <div class="home-buttons">
      <button onclick="loadFantasy('taxo')">FantaTaxo 25/26</button>
      <button onclick="loadFantasy('ralph')">Ralphcalcio 25/26</button>
    </div>
  </div>

  <!-- App -->
  <div id="app">
    <h2 id="fantasyTitle"></h2>
    <p id="introText"></p>

    <section class="controls">
      <select id="ownerFilter"><option value="">Tutti i proprietari</option></select>
      <select id="ruoloFilter"><option value="">Tutti i ruoli</option><option value="A">A</option><option value="C">C</option><option value="D">D</option><option value="P">P</option></select>
      <select id="teamFilter"><option value="">Tutti i club</option></select>
      <input id="searchBox" type="search" placeholder="Cerca giocatore…" />
      <button id="resetBtn">Reset</button>
    </section>

    <div id="legend">
      <span class="legend-chip">
        <span class="legend-color"></span>
        <span id="legendText"></span>
      </span>
    </div>

    <div class="col-toggle" id="colToggles"></div>
    <div id="table"></div>

    <p class="footer">Suggerimenti: tocca le intestazioni per ordinare • Trascina le colonne per riordinarle • Usa i toggle per mostrare/nascondere colonne.</p>
    <button onclick="showHome()">⬅ Torna alla scelta</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
<script type="module">
import dataTaxo from './data_taxo.js';
import dataRalph from './data_ralph.js';

const fmt0 = (n) => new Intl.NumberFormat('it-IT', { maximumFractionDigits: 0 }).format(n);

const configs = {
  taxo: {
    name: "FantaTAXO 25/26",
    data: dataTaxo,
    threshold: 5,
    intro: "Ogni squadra ha diritto max a 2 riconferme ≤5 crediti (no portieri)."
  },
  ralph: {
    name: "Ralphcalcio 25/26",
    data: dataRalph,
    threshold: 10,
    intro: "Ogni squadra ha diritto max a 2 riconferme ≤10 crediti (no portieri)."
  }
};

let table;
let currentConfig;

window.showHome = function() {
  document.getElementById("home").style.display = "block";
  document.getElementById("app").style.display = "none";
  if (table) { table.destroy(); table = null; }
};

window.loadFantasy = function(key) {
  currentConfig = configs[key];
  document.getElementById("home").style.display = "none";
  document.getElementById("app").style.display = "block";
  document.getElementById("fantasyTitle").textContent = currentConfig.name;
  document.getElementById("introText").textContent = currentConfig.intro;
  document.getElementById("legendText").innerHTML =
    `Evidenziati = Prezzo ≤ ${currentConfig.threshold} e non Portieri ⇒ riconferma (a 2×)`;

  if (table) table.destroy();

  const columns = [
    { key:"Squadra", title: "Proprietario", field: "Squadra", widthGrow: 1, visible: true },
    { key:"Nome", title: "Nome", field: "Nome", widthGrow: 2, visible: true },
    { key:"Club", title: "Club", field: "Squadra_Appartenenza", widthGrow: 1, visible: true },
    { key:"Ruolo", title: "Ruolo", field: "Ruolo", widthGrow: 1, visible: true },
    { key:"Ruoli_Mantra", title: "Ruoli Mantra", field: "Ruoli_Mantra", widthGrow: 1.2, visible: true },
    { key:"Prezzo", title: "Prezzo", field: "Prezzo", hozAlign:"right", widthGrow: 1, formatter:(cell)=>fmt0(cell.getValue()), visible: true },
    { key:"Quot", title: "Quot.", field: "Quotazione", hozAlign:"right", widthGrow: 1, visible: false },
    { key:"QuotM", title: "Quot. Mantra", field: "Quotazione_Mantra", hozAlign:"right", widthGrow: 1, visible: false },
    { key:"Riconferma", title: "Riconferma (2×)", field: "Prezzo", hozAlign:"right", widthGrow: 1,
      formatter:(cell)=>{ const d = cell.getRow().getData(); const v = Number(d.Prezzo); return (v<=currentConfig.threshold && d.Ruolo!=="P") ? fmt0(v*2) : "—"; }, visible: true },
    { key:"ID", title: "ID", field: "Fantacalcio_Id", visible:false }
  ];

  table = new Tabulator("#table", {
    data: currentConfig.data,
    layout: "fitColumns",
    responsiveLayout: "collapse",
    movableColumns: true,
    height: "75vh",
    columns: columns,
    rowFormatter: function(row){
      const d = row.getData();
      const isReconfirm = Number(d.Prezzo) <= currentConfig.threshold && d.Ruolo !== "P";
      row.getElement().classList.toggle("reconfirm", isReconfirm);
    }
  });

  // Column toggles
  const colToggles = document.getElementById("colToggles");
  colToggles.innerHTML = "";
  columns.forEach(col => {
    if (col.key === "ID") return;
    const id = "chk_" + col.key;
    const label = document.createElement("label");
    const input = document.createElement("input");
    input.type = "checkbox";
    input.id = id;
    input.checked = !!col.visible;
    input.addEventListener("change", () => {
      (input.checked ? table.showColumn(col.field) : table.hideColumn(col.field));
    });
    label.appendChild(input);
    label.appendChild(document.createTextNode(" " + col.title));
    colToggles.appendChild(label);
  });
  columns.forEach(col => { if (col.visible === false) table.hideColumn(col.field); });

  // Filters
  const ownerFilter = document.getElementById("ownerFilter");
  const ruoloFilter = document.getElementById("ruoloFilter");
  const teamFilter = document.getElementById("teamFilter");
  const searchBox = document.getElementById("searchBox");
  const resetBtn = document.getElementById("resetBtn");

  ownerFilter.innerHTML = '<option value=\"\">Tutti i proprietari</option>';
  [...new Set(currentConfig.data.map(d => d.Squadra))].sort().forEach(o=>{
    const opt = document.createElement("option"); opt.value=o; opt.textContent=o; ownerFilter.appendChild(opt);
  });

  teamFilter.innerHTML = '<option value=\"\">Tutti i club</option>';
  [...new Set(currentConfig.data.map(d => d.Squadra_Appartenenza))].sort().forEach(c=>{
    const opt = document.createElement("option"); opt.value=c; opt.textContent=c; teamFilter.appendChild(opt);
  });

  function applyFilters() {
    let filters = [];
    if (ownerFilter.value) filters.push({ field:"Squadra", type:"=", value: ownerFilter.value });
    if (ruoloFilter.value) filters.push({ field:"Ruolo", type:"=", value: ruoloFilter.value });
    if (teamFilter.value) filters.push({ field:"Squadra_Appartenenza", type:"=", value: teamFilter.value });
    table.clearFilter(true);
    if (filters.length) table.setFilter(filters);
    if (searchBox.value) {
      const q = searchBox.value.toLowerCase();
      table.addFilter((data) => (data.Nome || '').toLowerCase().includes(q));
    }
  }

  ownerFilter.onchange = applyFilters;
  ruoloFilter.onchange = applyFilters;
  teamFilter.onchange = applyFilters;
  searchBox.oninput = applyFilters;
  resetBtn.onclick = () => {
    ownerFilter.value = "";
    ruoloFilter.value = "";
    teamFilter.value = "";
    searchBox.value = "";
    table.clearFilter(true);
  };
};
</script>
</body>
</html>
